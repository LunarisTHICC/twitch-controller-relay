<!DOCTYPE html>
<html>
<head>
  <title>Viewer Controller + Stream</title>
  <style>
    body, html {
      margin: 0; padding: 0; height: 100%; width: 100%;
      background: black; overflow: hidden;
    }
    #twitch-player {
      position: absolute; top: 0; left: 0;
      width: 100%; height: 100%;
      border: none;
    }
    #debug-toggle {
      position: absolute; top: 10px; right: 10px;
      z-index: 1000;
    }
    #debug-panel {
      position: absolute; top: 40px; right: 10px;
      background: rgba(0,0,0,0.7); color: #0f0;
      font-family: monospace; font-size: 12px;
      padding: 5px; max-width: 300px; max-height: 200px;
      overflow-y: auto; display: none;
      z-index: 999;
    }
  </style>
</head>
<body>
  <iframe id="twitch-player" allowfullscreen></iframe>
  <button id="debug-toggle">Toggle Debug</button>
  <div id="debug-panel"></div>

  <script>
    const domain = window.location.hostname;
    document.getElementById("twitch-player").src =
      `https://player.twitch.tv/?channel=junkfoodjon&parent=${domain}`;

    const debugPanel = document.getElementById('debug-panel');
    const toggleBtn = document.getElementById('debug-toggle');
    toggleBtn.addEventListener('click', () => {
      debugPanel.style.display = (debugPanel.style.display === 'none') ? 'block' : 'none';
    });

    function logDebug(msg) {
      const p = document.createElement('div');
      p.textContent = msg;
      debugPanel.appendChild(p);
      debugPanel.scrollTop = debugPanel.scrollHeight;
    }

    const ws = new WebSocket("wss://complicatedly-lacier-cristine.ngrok-free.dev/viewer");
    let viewerID = null;

    const buttonMap = {
      0: "A", 1: "B", 2: "X", 3: "Y",
      4: "LB", 5: "RB",
      6: "LT", 7: "RT",
      8: "Back", 9: "Start",
      10: "LS", 11: "RS",
      12: "DPadUp", 13: "DPadDown",
      14: "DPadLeft", 15: "DPadRight"
    };

    ws.onopen = () => {
      logDebug("Connected to relay server.");
      ws.send(JSON.stringify({ type: "hello" }));
    };

    ws.onmessage = (event) => {
      try {
        const msg = JSON.parse(event.data);
        if (msg.type === "welcome" && msg.viewer_id) {
          viewerID = msg.viewer_id;
          logDebug("Handshake complete. Viewer ID: " + viewerID);
        }
      } catch (e) {
        logDebug("Error parsing server message: " + e);
      }
    };

    ws.onclose = () => logDebug("Disconnected from relay server.");
    ws.onerror = (err) => logDebug("WebSocket error: " + err);

    function pollGamepads() {
      const gamepads = navigator.getGamepads ? navigator.getGamepads() : [];
      if (gamepads[0] && viewerID) {
        const gp = gamepads[0];
        const buttons = [];
        gp.buttons.forEach((btn, i) => {
          if (btn.pressed && buttonMap[i]) {
            buttons.push(buttonMap[i]);
          }
        });
        const axes = gp.axes.map(v => parseFloat(v.toFixed(2)));
        const payload = {
          viewer: viewerID,
          buttons: buttons,
          axes: axes
        };
        if (ws.readyState === WebSocket.OPEN) {
          ws.send(JSON.stringify(payload));
        }
        logDebug("Sent: " + JSON.stringify(payload));
      }
      requestAnimationFrame(pollGamepads);
    }

    window.addEventListener("gamepadconnected", (e) => {
      logDebug("Gamepad connected: " + e.gamepad.id);
      pollGamepads();
    });

    window.addEventListener("gamepaddisconnected", (e) => {
      logDebug("Gamepad disconnected: " + e.gamepad.id);
    });
  </script>
</body>
</html>
