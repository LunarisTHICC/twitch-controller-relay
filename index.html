<!DOCTYPE html>
<html>
<head>
  <title>Viewer Controller</title>
  <style>
    body { font-family: Arial, sans-serif; background: #111; color: #eee; }
    #status { margin-bottom: 10px; font-weight: bold; }
    #viewerId { margin-bottom: 10px; color: #0ff; }
    #log {
      width: 100%;
      height: 250px;
      background: #222;
      color: #0f0;
      font-family: monospace;
      overflow-y: scroll;
      padding: 5px;
      border: 1px solid #555;
    }
    button { margin: 5px; padding: 8px 12px; }
  </style>
</head>
<body>
  <h1>Viewer Controller</h1>
  <p id="status">Connecting...</p>
  <p id="viewerId">Viewer ID: (not assigned yet)</p>
  <button id="startBtn">Start Sending</button>
  <button id="stopBtn" disabled>Stop Sending</button>
  <div id="log"></div>

  <script>
    const buttonNames = [
      "A", "B", "X", "Y",
      "LB", "RB", "LT", "RT",
      "Back", "Start", "LS", "RS",
      "DPadUp", "DPadDown", "DPadLeft", "DPadRight", "Home"
    ];

    const ws = new WebSocket("wss://complicatedly-lacier-cristine.ngrok-free.dev/input");

    const statusEl = document.getElementById("status");
    const logEl = document.getElementById("log");
    const viewerIdEl = document.getElementById("viewerId");
    const startBtn = document.getElementById("startBtn");
    const stopBtn = document.getElementById("stopBtn");

    let viewerId = null;
    let pollInterval = null;

    function log(msg) {
      const line = document.createElement("div");
      line.textContent = `[${new Date().toLocaleTimeString()}] ${msg}`;
      logEl.appendChild(line);
      logEl.scrollTop = logEl.scrollHeight;
    }

    ws.onopen = () => {
      statusEl.textContent = "✅ Connected to relay";
      log("WebSocket connected");
    };

    ws.onclose = (evt) => {
      statusEl.textContent = "❌ Disconnected";
      log(`WebSocket closed (code ${evt.code})`);
    };

    ws.onerror = (err) => {
      statusEl.textContent = "⚠️ Error";
      log("WebSocket error: " + err);
    };

    ws.onmessage = (evt) => {
      try {
        const data = JSON.parse(evt.data);
        if (data.viewer && !viewerId) {
          viewerId = data.viewer;
          viewerIdEl.textContent = "Viewer ID: " + viewerId;
          log("Assigned viewer ID: " + viewerId);
        }
      } catch (e) {
        log("Non-JSON message: " + evt.data);
      }
    };

    function pollGamepad() {
      const gamepads = navigator.getGamepads();
      if (!gamepads) return;

      const gp = gamepads[0];
      if (!gp) {
        log("No gamepad detected");
        return;
      }

      const buttons = gp.buttons
        .map((b, i) => b.pressed ? buttonNames[i] : null)
        .filter(b => b !== null);

      const axes = gp.axes.map(a => parseFloat(a.toFixed(2)));

      const payload = { buttons, axes };

      if (ws.readyState === WebSocket.OPEN) {
        ws.send(JSON.stringify(payload));
        log("Sent: " + JSON.stringify(payload));
      }
    }

    startBtn.onclick = () => {
      if (!pollInterval) {
        pollInterval = setInterval(pollGamepad, 200);
        log("Started sending inputs");
        startBtn.disabled = true;
        stopBtn.disabled = false;
      }
    };

    stopBtn.onclick = () => {
      if (pollInterval) {
        clearInterval(pollInterval);
        pollInterval = null;
        log("Stopped sending inputs");
        startBtn.disabled = false;
        stopBtn.disabled = true;
      }
    };
  </script>
</body>
</html>
