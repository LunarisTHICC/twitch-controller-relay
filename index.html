<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>WebRTC Viewer</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <!-- Oswald for intro, Montserrat/Orbitron for main UI -->
  <link href="https://fonts.googleapis.com/css2?family=Oswald:wght@500;700&family=Montserrat:wght@500;700&family=Orbitron:wght@600&display=swap" rel="stylesheet">
  <style>
    :root { --bg:#0e0e10; --panel:#18181b; --edge:#23232a; --fg:#efeff1; --muted:#b9b9c2; --accent:#9146ff; --accent-2:#772ce8; --ok:#22c55e; --warn:#f59e0b; --bad:#ef4444; --chat-w:360px; --banner-h:44px; }
    *{box-sizing:border-box} html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--fg);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,"Helvetica Neue",Arial,"Noto Sans";}
    button, input, select, label { font-family:"Orbitron", system-ui, sans-serif; letter-spacing:0.4px; }

    /* Banner */
    #brandBanner{position:sticky; top:0; z-index:50; height:var(--banner-h); background:linear-gradient(90deg,rgba(12,10,22,.9),rgba(20,14,38,.9)); border-bottom:1px solid #241d3a; overflow:hidden; display:flex; align-items:center;}
    #brandTrack{display:flex; gap:40px; align-items:center; white-space:nowrap; will-change:transform; animation:scrollX 26s linear infinite}
    #brandTrack .item{font-family:"Orbitron",system-ui,sans-serif;font-size:14px;letter-spacing:1.4px;line-height:1;color:#e9e2ff;text-shadow:0 0 12px rgba(145,70,255,.55),0 0 2px rgba(145,70,255,.9);}
    .dot{display:inline-block;width:7px;height:7px;border-radius:50%;background:var(--accent);box-shadow:0 0 10px var(--accent)}
    @keyframes scrollX{0%{transform:translateX(0)}100%{transform:translateX(-50%)}}

    /* Debug header */
    header{display:flex;align-items:center;gap:8px;padding:8px 14px;background:#1f1f23;border-bottom:1px solid var(--edge);position:sticky;top:var(--banner-h);z-index:10;flex-wrap:wrap}
    .pill{display:inline-block;padding:4px 8px;border-radius:999px;font-size:12px;line-height:14px;background:#2a2a32;border:1px solid #3a3a4a;color:#cfd3df}
    .pill.ok{background:#15321f;border-color:#1e6a33;color:#a5e7b9}
    .pill.warn{background:#3a2a18;border-color:#b57a28;color:#ffd89a}
    .pill.bad{background:#3a1a1a;border-color:#b52828;color:#ff9a9a}
    #wsUrl{margin-left:auto;font-family:ui-monospace,Menlo,Consolas,monospace;font-size:12px;color:#9fb2d1}

    /* Layout */
    main{display:grid;grid-template-columns:1fr;gap:10px;padding:12px}
    body.chat-open #sidePanel{display:grid}
    body.chat-open main{ grid-template-columns:1fr var(--chat-w); }

    /* Video */
    #videoWrap{position:relative;background:#0f1320;border:1px solid #1d2436;border-radius:8px;overflow:hidden;aspect-ratio:16/9;min-height:360px;contain:layout paint}
    #vid{width:100%;height:100%;display:block;background:#000;object-fit:contain;aspect-ratio:inherit}
    #overlay{position:absolute;inset:0;display:grid;place-items:center;background:linear-gradient(180deg,rgba(10,14,21,.65),rgba(10,14,21,.75));pointer-events:none;transition:opacity .15s}
    #overlay[hidden]{display:none}
    #ovText{font-size:16px;color:#c6d3ea;text-shadow:0 1px 2px rgba(0,0,0,.6)}

    /* Controls */
    #controls{display:flex;flex-wrap:wrap;gap:10px;padding:10px 0;align-items:center}
    button,input,select{border-radius:8px;border:1px solid #2a2a32;color:#f3edff;background:#1e123a}
    button.accent{background:linear-gradient(180deg,var(--accent),var(--accent-2));border-color:#5f37d6;color:#fff;box-shadow:0 6px 18px rgba(145,70,255,.25),inset 0 0 0 1px rgba(255,255,255,.05)}
    button.accent:hover{filter:brightness(1.05)} button.accent:active{transform:translateY(1px)}
    input[type=range]{appearance:none;height:6px;background:#1d1931;border:1px solid #2b2350;width:160px;border-radius:999px}
    input[type=range]::-webkit-slider-thumb{appearance:none;width:14px;height:14px;border-radius:50%;background:var(--accent);box-shadow:0 0 8px rgba(145,70,255,.55);border:1px solid #fff1}

    /* Side panel */
    #sidePanel{display:none;grid-template-rows:min-content 1fr;gap:10px}
    #chatWrap{border:1px solid #1d2436;border-radius:8px;overflow:hidden;background:#0d1322;min-height:320px;display:flex;flex-direction:column;height:100%;}
    #chatIframe{width:100%;height:100%;min-height:320px;flex:1 1 0;display:block;border:0;background:#0d1322;}

    /* Logs (debugger) */
    #logPanel{display:grid;grid-template-rows:min-content 1fr;border:1px solid #1d2436;border-radius:8px;overflow:hidden}
    #logHeader{display:flex;align-items:center;justify-content:space-between;padding:8px 10px;background:#121824;border-bottom:1px solid #1d2436}
    #log{margin:0;padding:10px;font-family:ui-monospace,Menlo,Consolas,monospace;font-size:12px;line-height:1.4;background:#0d1322;white-space:pre;overflow:auto}

    /* Footer */
    footer{display:flex;align-items:center;justify-content:space-between;gap:10px;padding:12px 14px;color:#7a8fb2;border-top:1px solid #20283a;background:#0e1524}
    #footerRight{margin-left:auto;display:flex;align-items:center;gap:8px}
    #btnDebugger{padding:6px 10px;font-size:12px;opacity:.9}

    /* Clean vs Debugger */
    body.clean header{display:none!important}
    body.clean #logPanel{display:none!important}
    body.clean #controls>*{display:none}
    body.clean #btnChat, body.clean #volumeWrap, body.clean #btnFullscreen, body.clean #iconRow{display:flex}
    body:not(.clean) #btnFullscreen{display:none}
    .fs-active #videoWrap{box-shadow:0 0 0 2px var(--accent) inset}

    /* --- Animated Intro Styles --- */
    #intro-overlay {
      position: fixed;
      inset: 0;
      background: black;
      z-index: 9999;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      transition: opacity 1s;
      opacity: 1;
      pointer-events: auto;
    }
    #eyes-container {
      display: flex;
      flex-direction: row;
      justify-content: center;
      align-items: center;
      min-height: 200px;
      gap: 60px;
      position: relative;
      width: 340px;
      max-width: 90vw;
      margin: 0 auto;
    }
    .eye-wrap {
      transition: opacity 0.9s, transform 0.7s cubic-bezier(.8,2,.6,1);
      will-change: transform, opacity;
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0;
    }
    .eye-wrap.visible {
      opacity: 1;
    }
    .eye-svg {
      width: 120px;
      height: 80px;
      display: block;
    }
    #intro-text {
      color: #e5e5e5;
      font-size: 3.0rem;
      font-family: 'Oswald', 'Arial Narrow', Arial, Helvetica, sans-serif;
      font-weight: 700;
      letter-spacing: 0.12em;
      opacity: 0;
      margin-top: 6px;
      background: none;
      transition: opacity 2s;
      text-align: center;
      user-select: none;
      pointer-events: none;
      text-shadow: 0 1px 4px rgba(0,0,0,0.18);
      text-transform: uppercase;
    }
    #intro-overlay.fade-out {
      opacity: 0;
      pointer-events: none;
      transition: opacity 1s;
    }
    @media (max-width: 600px) {
      #eyes-container {
        min-height: 120px;
        gap: 24px;
        width: 160px;
      }
      .eye-svg {
        width: 68px;
        height: 48px;
      }
      #intro-text {
        font-size: 1.6rem;
        margin-top: 4px;
      }
    }
    /* --- End Animated Intro --- */
  </style>
</head>
<body class="clean">

  <!-- Animated HTML Intro Overlay -->
  <div id="intro-overlay">
    <div id="eyes-container"></div>
    <div id="intro-text">Doppelganger</div>
  </div>
  <!-- End Intro -->

  <div id="brandBanner" role="banner" aria-label="Credits banner"><div id="brandTrack"></div></div>

  <header>
    <span id="pRelay" class="pill">Relay</span><span id="pWs" class="pill">WS</span><span id="pSig" class="pill">Signaling</span><span id="pIce" class="pill">ICE</span><span id="pDtls" class="pill">DTLS</span><span id="pPc" class="pill">Peer</span><span id="pDc" class="pill">DC</span><span id="pAv" class="pill">A/V</span><span id="pTransport" class="pill">Transport</span>
    <span id="wsUrl" class="pill">ws://</span>
  </header>

  <main>
    <section>
      <div id="videoWrap">
        <video id="vid" playsinline muted autoplay></video>
        <div id="overlay"><div id="ovText">Connecting…</div></div>
      </div>
      <div id="controls">
        <button id="btnChat" class="accent" title="Toggle Twitch chat">Twitch Chat</button>

        <div id="volumeWrap" style="display:flex;align-items:center;gap:8px">
          <label for="vol" style="opacity:.8">Volume</label>
          <input id="vol" type="range" min="0" max="100" value="0" />
          <div id="iconRow">
            <button id="btnMute" class="muted" aria-label="Toggle mute" title="Toggle audio">
              <svg viewBox="0 0 24 24" aria-hidden="true">
                <path d="M3 10v4h4l5 4V6L7 10H3z"></path>
                <path d="M14.5 12a4.5 4.5 0 0 0-1.2-3.1l1.4-1.4A6.5 6.5 0 0 1 16.5 12a6.5 6.5 0 0 1-1.8 4.5l-1.4-1.4A4.5 4.5 0 0 0 14.5 12z"></path>
                <path d="M18 12a8 8 0 0 0-2.1-5.4l1.4-1.4A10 10 0 0 1 20 12a10 10 0 0 1-2.7 6.8l-1.4-1.4A8 8 0 0 0 18 12z"></path>
              </svg>
            </button>
            <div id="padIconWrap" class="off" title="Controller status">
              <svg id="padIcon" class="off" viewBox="0 0 24 24" aria-hidden="true">
                <path d="M7 8h10a4 4 0 0 1 3.8 2.7l1.1 3.2A3 3 0 0 1 19 18h-1.7l-1.8-2H8.5l-1.8 2H5A3 3 0 0 1 2.1 13.9l1.1-3.2A4 4 0 0 1 7 8zm3 2H8v2H6v2h2v2h2v-2h2v-2h-2v-2zm8 1.5a1.5 1.5 0 1 0 0 3 1.5 1.5 0 0 0 0-3z"/>
              </svg>
            </div>
          </div>
        </div>

        <button id="btnFullscreen" class="accent" title="Fullscreen">Fullscreen</button>
        <button id="btnDownloadLogs">Download logs</button>
      </div>
    </section>

    <aside id="sidePanel">
      <div id="chatWrap" hidden><iframe id="chatIframe" title="Twitch chat"></iframe></div>
      <div id="logPanel"><div id="logHeader"><strong>Viewer logs</strong><span style="opacity:.7">Use “Download logs”.</span></div><pre id="log"></pre></div>
    </aside>
  </main>

  <footer>
    <small>Status indicators reflect last known state and auto-recover triggers.</small>
    <div id="footerRight"><button id="btnDebugger" title="Toggle debug UI">Debugger</button></div>
  </footer>

  <!-- Scripts: Animated Intro (runs first), then Viewer scripts -->
  <script>
    // --- Animated Intro JS ---
    // Use #e5e5e5 for all "white" lines (10% darker than #fff)
    function getEyeSVG(rx = 50, ry = 30, pupilDx = 0, pupilDy = 0, eyelidOpacity = 0) {
      return `
<svg class="eye-svg" viewBox="0 0 120 80" fill="none">
  <ellipse class="eyeball" cx="60" cy="40" rx="${rx}" ry="${ry}" stroke="#e5e5e5" stroke-width="4" fill="#181818"/>
  <ellipse class="iris" cx="${60 + pupilDx}" cy="${40 + pupilDy}" rx="18" ry="18" fill="#e5e5e5"/>
  <ellipse class="pupil" cx="${60 + pupilDx}" cy="${40 + pupilDy}" rx="8" ry="8" fill="#1a1a1a"/>
  <ellipse class="eyelid" cx="60" cy="40" rx="${rx}" ry="${ry}" fill="black" style="opacity:${eyelidOpacity};"/>
</svg>
      `;
    }

    const overlayIntro = document.getElementById('intro-overlay');
    const eyesContainer = document.getElementById('eyes-container');
    const introText = document.getElementById('intro-text');
    let animationSkipped = false;
    let skipTimeout;

    function animateEyeShape(eye, opts, duration = 400) {
      const eyeball = eye.querySelector('.eyeball');
      const iris = eye.querySelector('.iris');
      const pupil = eye.querySelector('.pupil');
      let start = null;
      const rx0 = +eyeball.getAttribute('rx');
      const ry0 = +eyeball.getAttribute('ry');
      const irisCx0 = +iris.getAttribute('cx');
      const irisCy0 = +iris.getAttribute('cy');
      const pupilCx0 = +pupil.getAttribute('cx');
      const pupilCy0 = +pupil.getAttribute('cy');
      const rx1 = opts.rx;
      const ry1 = opts.ry;
      const irisCx1 = 60 + opts.pupilDx;
      const irisCy1 = 40 + opts.pupilDy;
      const pupilCx1 = 60 + opts.pupilDx;
      const pupilCy1 = 40 + opts.pupilDy;

      function stepEye(ts) {
        if (!start) start = ts;
        let t = Math.min(1, (ts - start)/duration);
        t = t<0.5 ? 4*t*t*t : 1-(-2*t+2)**3/2;
        eyeball.setAttribute('rx', rx0 + (rx1 - rx0)*t);
        eyeball.setAttribute('ry', ry0 + (ry1 - ry0)*t);
        iris.setAttribute('cx', irisCx0 + (irisCx1 - irisCx0)*t);
        iris.setAttribute('cy', irisCy0 + (irisCy1 - irisCy0)*t);
        pupil.setAttribute('cx', pupilCx0 + (pupilCx1 - pupilCx0)*t);
        pupil.setAttribute('cy', pupilCy0 + (pupilCy1 - pupilCy0)*t);
        const eyelid = eye.querySelector('.eyelid');
        eyelid.setAttribute('rx', rx0 + (rx1 - rx0)*t);
        eyelid.setAttribute('ry', ry0 + (ry1 - ry0)*t);
        if (t < 1) requestAnimationFrame(stepEye);
      }
      requestAnimationFrame(stepEye);
    }

    function setBlink(eye, closed, duration = 200) {
      const eyelid = eye.querySelector('.eyelid');
      eyelid.style.transition = `opacity ${duration}ms`;
      eyelid.style.opacity = closed ? 1 : 0;
    }
    function widenEye(eye, widened = true) {
      const eyeball = eye.querySelector('.eyeball');
      const eyelid = eye.querySelector('.eyelid');
      const targetRy = widened ? 38 : 30;
      eyeball.setAttribute('ry', targetRy);
      eyelid.setAttribute('ry', targetRy);
    }

    function fadeInEyeWrap(eyeWrap, duration = 900, cb) {
      eyeWrap.style.transition = `opacity ${duration}ms`;
      setTimeout(() => {
        eyeWrap.style.opacity = 1;
        if (typeof cb === "function") setTimeout(cb, duration);
      }, 20);
    }

    function fadeOut(element, duration = 800) {
      element.style.opacity = 0;
      element.style.transition = `opacity ${duration}ms`;
    }

    function fadeIn(element, duration = 2000) {
      element.style.opacity = 1;
      element.style.transition = `opacity ${duration}ms`;
    }

    function animateIntro() {
      eyesContainer.innerHTML = '';
      introText.style.opacity = 0;
      introText.style.backgroundPosition = 'left';

      const eyeForward = {rx:50, ry:30, pupilDx:0, pupilDy:0};
      const eyeTurnLeft = {rx:40, ry:33, pupilDx:-23, pupilDy:2};
      const eyeTurnRight = {rx:40, ry:33, pupilDx:23, pupilDy:2};
      const leftStartOffset = 40;
      const leftEndOffset = 0;

      // Create left eye wrap, opacity 0 for fade-in, start closer to center for smooth slide
      const leftEyeWrap = document.createElement('div');
      leftEyeWrap.className = 'eye-wrap';
      leftEyeWrap.style.opacity = 0;
      leftEyeWrap.style.transform = `translateX(${leftStartOffset}px)`;
      leftEyeWrap.innerHTML = getEyeSVG(eyeForward.rx, eyeForward.ry, eyeForward.pupilDx, eyeForward.pupilDy, 0);
      eyesContainer.appendChild(leftEyeWrap);

      fadeInEyeWrap(leftEyeWrap, 900, () => {
        if (animationSkipped) return skipToEnd();
        setBlink(leftEyeWrap.firstElementChild, true, 120);
        setTimeout(() => setBlink(leftEyeWrap.firstElementChild, false, 160), 180);

        // After a second, fade in right eye and slide left eye smoothly
        setTimeout(() => {
          if (animationSkipped) return skipToEnd();
          const rightEyeWrap = document.createElement('div');
          rightEyeWrap.className = 'eye-wrap';
          rightEyeWrap.style.opacity = 0;
          rightEyeWrap.innerHTML = getEyeSVG(eyeForward.rx, eyeForward.ry, eyeForward.pupilDx, eyeForward.pupilDy, 0);

          eyesContainer.appendChild(rightEyeWrap);

          // The fix: trigger both transitions in the same frame, using fadeInEyeWrap for right eye
          requestAnimationFrame(() => {
            leftEyeWrap.style.transition = 'transform 0.7s cubic-bezier(.8,2,.6,1), opacity 0.7s';
            leftEyeWrap.style.transform = `translateX(${leftEndOffset}px)`;
            fadeInEyeWrap(rightEyeWrap, 900);
          });

          setTimeout(() => {
            if (animationSkipped) return skipToEnd();
            animateEyeShape(leftEyeWrap.firstElementChild, eyeTurnRight, 400);
            animateEyeShape(rightEyeWrap.firstElementChild, eyeTurnLeft, 400);
            widenEye(leftEyeWrap.firstElementChild, true);
          }, 700);

          setTimeout(() => {
            if (animationSkipped) return skipToEnd();
            setBlink(leftEyeWrap.firstElementChild, true, 80);
            setBlink(rightEyeWrap.firstElementChild, true, 80);
            setTimeout(() => {
              setBlink(leftEyeWrap.firstElementChild, false, 100);
              setBlink(rightEyeWrap.firstElementChild, false, 100);

              setTimeout(() => {
                setBlink(leftEyeWrap.firstElementChild, true, 80);
                setBlink(rightEyeWrap.firstElementChild, true, 80);

                setTimeout(() => {
                  setBlink(leftEyeWrap.firstElementChild, false, 100);
                  setBlink(rightEyeWrap.firstElementChild, false, 100);

                  setTimeout(() => {
                    animateEyeShape(leftEyeWrap.firstElementChild, eyeForward, 350);
                    animateEyeShape(rightEyeWrap.firstElementChild, eyeForward, 350);
                    widenEye(leftEyeWrap.firstElementChild, false);

                    setTimeout(() => {
                      if (animationSkipped) return skipToEnd();
                      fadeIn(introText, 2000);
                      introText.style.backgroundPosition = 'right';
                      setTimeout(() => {
                        fadeOut(leftEyeWrap, 600);
                        fadeOut(rightEyeWrap, 600);
                        fadeOut(introText, 600);
                        setTimeout(() => fadeOut(overlayIntro, 800), 600);
                      }, 1300);
                    }, 380);
                  }, 350);
                }, 180);
              }, 160);
            }, 110);
          }, 900);
        }, 1100);
      });

      skipTimeout = setTimeout(() => fadeOut(overlayIntro, 900), 10100);
    }

    function skipToEnd() {
      if (animationSkipped) return;
      animationSkipped = true;
      clearTimeout(skipTimeout);
      fadeOut(overlayIntro, 700);
    }

    function setupSkip() {
      let lastClick = 0, clickCount = 0, lastKey = 0, keyCount = 0;
      overlayIntro.addEventListener('click', () => {
        const now = Date.now();
        if (now - lastClick < 400) clickCount++;
        else clickCount = 1;
        lastClick = now;
        if (clickCount >= 2) skipToEnd();
      });
      window.addEventListener('keydown', (e) => {
        const now = Date.now();
        if (now - lastKey < 400) keyCount++;
        else keyCount = 1;
        lastKey = now;
        if (keyCount >= 2) skipToEnd();
      });
    }

    window.addEventListener('DOMContentLoaded', () => {
      animateIntro();
      setupSkip();
      overlayIntro.addEventListener('transitionend', () => {
        if (overlayIntro.style.opacity === '0') overlayIntro.style.display = 'none';
      });
    });
  </script>
  <script>
    // --- Viewer.html JS: all original code below, runs with no change ---

    const logEl=document.getElementById('log'); function log(m){const t=new Date().toLocaleTimeString(); logEl.textContent+=`[${t}] ${m}\n`; logEl.scrollTop=logEl.scrollHeight;}
    function pill(id,cls,text){const el=document.getElementById(id); if(!el) return; el.className='pill '+(cls||''); if(text) el.textContent=text;}

    // ----- Banner with meta fallbacks -----
    // NOTE: Banner stats are now static per user request!
    const PROJECT_START = new Date('2025-09-29T00:00:00Z');
    const brandTrack = document.getElementById('brandTrack');
    function item(text){ const s=document.createElement('span'); s.className='item'; const d1=document.createElement('i'); d1.className='dot'; const d2=document.createElement('i'); d2.className='dot'; s.appendChild(d1); s.appendChild(document.createTextNode(' ')); s.appendChild(document.createTextNode(text)); s.appendChild(document.createTextNode(' ')); s.appendChild(d2); return s; }
    async function buildBanner(){
      brandTrack.innerHTML='';
      // Static stats per user request
      const now=new Date(); 
      // Local time string formatted as HH:MM (24hr)
      const hh=String(now.getHours()).padStart(2,'0'), mm=String(now.getMinutes()).padStart(2,'0');
      const days=Math.max(1, Math.floor((now-PROJECT_START)/86400000));
      const texts = [
        `Different architecture types used.`,
        `Local time: ${hh}:${mm}`,
        `Viewer mode: ${document.body.classList.contains('clean') ? 'Clean' : 'Debugger'}`,
        `Made by JunkfoodJon with CoPilot and GitHub`,
        `How long this project took: ${days} day${days!==1?'s':''}`,
        `Lines of code used: 1424+`,
        `Languages used: Python, HTML, CSS, JavaScript`,
        `Models used: Gpt-5 & GPT-4.`
      ];
      const frag=document.createDocumentFragment();
      for(let k=0;k<2;k++){ texts.forEach(t=>frag.appendChild(item(t))); }
      brandTrack.appendChild(frag);
    }

    // ----- Chat (force junkfoodjon, dark) -----
    const chatWrap=document.getElementById('chatWrap'), chatIframe=document.getElementById('chatIframe');
    function setChatSrc(){
      const parent=location.hostname; // Twitch requires hostname, not host/port
      const ch='junkfoodjon';
      // Twitch dark mode, allow iframe to fill entire chatWrap flexbox area
      chatIframe.src=`https://www.twitch.tv/embed/${encodeURIComponent(ch)}/chat?parent=${parent}&theme=dark`;
      chatIframe.style.background='#0d1322';
      chatIframe.style.height='100%';
      chatIframe.style.width='100%';
      chatIframe.style.display='block';
      chatIframe.allowTransparency='true';
    }
    function toggleChat(){ 
      const open=!document.body.classList.contains('chat-open'); 
      if(open){ 
        document.body.classList.add('chat-open'); 
        chatWrap.hidden=false;
        // Ensure chat scales vertically on open
        chatWrap.style.height = '100%';
        chatIframe.style.height = '100%';
      } else { 
        document.body.classList.remove('chat-open'); 
        chatWrap.hidden=true; 
      } 
    }
    document.getElementById('btnChat').onclick=toggleChat;

    // ----- Video / audio -----
    const vid=document.getElementById('vid'), vol=document.getElementById('vol'), btnMute=document.getElementById('btnMute');
    const overlay=document.getElementById('overlay'), ovText=document.getElementById('ovText'), videoWrap=document.getElementById('videoWrap');

    function ensurePlay(){ const p=vid.play(); if(p&&p.then)p.catch(()=>{}); }
    function updateMuteVisual(){ const muted=vid.muted||vid.volume===0; btnMute.classList.toggle('muted',muted); btnMute.setAttribute('aria-pressed', String(!muted)); }
    function lockAspectFromTrack(track){ try{ const st = track.getSettings?.()||{}; const w = st.width||0, h=st.height||0; if(w>0 && h>0) videoWrap.style.aspectRatio = `${w} / ${h}`; }catch{} }

    let autoUnmuted = false;
    async function firstInteract(){ if(autoUnmuted) return; autoUnmuted = true; try{ const stored = Math.max(0, Math.min(100, parseInt(localStorage.getItem('viewerVolume')||'30',10))); if(vid.volume===0&&stored>0){ vid.volume=stored/100; vol.value=stored; } vid.muted=false; updateMuteVisual(); ensurePlay(); }catch{} }
    ['pointerdown','keydown'].forEach(ev=>window.addEventListener(ev, firstInteract, {once:true, capture:true}));

    btnMute.onclick=async()=>{ try{ if(vid.muted || vid.volume===0){ vid.muted=false; if (vid.volume===0) { const stored=Math.max(0,Math.min(100,parseInt(localStorage.getItem('viewerVolume')||'30',10)||30)); vid.volume=stored/100; vol.value=stored; } }else{ vid.muted=true; } updateMuteVisual(); ensurePlay(); }catch{} };
    vol.addEventListener('input', ()=>{ const v=Math.max(0,Math.min(100,parseInt(vol.value||'0',10)))/100; vid.volume=v; localStorage.setItem('viewerVolume', String(Math.round(v*100))); if(v>0) vid.muted=false; updateMuteVisual(); ensurePlay(); });
    const initVol = Math.max(0, Math.min(100, parseInt(localStorage.getItem('viewerVolume')||'0',10))); vol.value = initVol; vid.volume = initVol/100; if(initVol===0) vid.muted=true; updateMuteVisual();

    // Fullscreen
    function toggleFs(){ if(!document.fullscreenElement){ (videoWrap.requestFullscreen||videoWrap.webkitRequestFullscreen||videoWrap.msRequestFullscreen||document.body.requestFullscreen||function(){})?.call(videoWrap); } else { (document.exitFullscreen||document.webkitExitFullscreen||document.msExitFullscreen||function(){})?.call(document); } }
    document.getElementById('btnFullscreen').onclick=toggleFs;
    videoWrap.ondblclick=toggleFs;
    document.addEventListener('fullscreenchange', ()=>{ document.body.classList.toggle('fs-active', !!document.fullscreenElement); });

    document.getElementById('btnDebugger').onclick=()=>{ document.body.classList.toggle('clean'); buildBanner(); };

    // ----- Connection -----
    const params=new URLSearchParams(location.search);
    const relayHost=(params.get('relay')||location.host).replace(/^https?:\/\//,'').replace(/\/+$/,'');
    const wsUrl=`${location.protocol==='https:'?'wss':'ws'}://${relayHost}/ws/viewer`;
    document.getElementById('wsUrl').textContent=wsUrl;
    pill('pRelay','ok','Relay: '+relayHost); pill('pTransport','ok','Transport: WebRTC');

    let pc, ws, dc, viewerID=null, restarting=false, hbTimer=null, stallTimer=null;
    let retryDelay = 700;
    const inbound=new MediaStream();

    function startViewer(){
      log('WS URL → '+wsUrl); pill('pWs','','WS: connecting'); showOverlay('Connecting…');

      pc=new RTCPeerConnection({iceServers:[{urls:['stun:stun.l.google.com:19302','stun:global.stun.twilio.com:3478']}], bundlePolicy:'max-bundle'});
      const vTrans=pc.addTransceiver('video',{direction:'recvonly'}); pc.addTransceiver('audio',{direction:'recvonly'});

      try{
        const caps=RTCRtpReceiver.getCapabilities('video'); const codecs=(caps&&caps.codecs)||[];
        const h264=codecs.filter(c=>(c.mimeType||'').toLowerCase().includes('h264'));
        const vp8 =codecs.filter(c=>(c.mimeType||'').toLowerCase().includes('vp8'));
        const prefs=[...h264,...vp8];
        if(vTrans&&vTrans.setCodecPreferences&&prefs.length){ vTrans.setCodecPreferences(prefs); }
      }catch{}

      dc=pc.createDataChannel('inputs'); dc.onopen=()=>pill('pDc','ok','DC: open'); dc.onclose=()=>pill('pDc','bad','DC: closed');

      pc.ontrack=(e)=>{
        if(!inbound.getTracks().includes(e.track)) inbound.addTrack(e.track);
        if(vid.srcObject!==inbound) vid.srcObject=inbound;
        pill('pAv','ok','A/V: attached'); hideOverlay(); ensurePlay();
        if(e.track.kind==='video'){ lockAspectFromTrack(e.track); retryDelay = 700; }
      };
      pc.oniceconnectionstatechange=()=>{ const s=pc.iceConnectionState; pill('pIce', (s==='connected'||s==='completed')?'ok':(s==='failed'?'bad':'warn'), 'ICE: '+s); if(s==='failed'){ showOverlay('Reconnecting…'); restartSoon(); } };
      pc.onconnectionstatechange=()=>{ const s=pc.connectionState; pill('pPc', s==='connected'?'ok':(s==='failed'?'bad':'warn'), 'Peer: '+s); pill('pDtls', s==='connected'?'ok':(s==='failed'?'bad':'warn'), 'DTLS: '+s); };
      pc.onicecandidate=(ev)=>{ if(ev.candidate && viewerID && ws?.readyState===1){ ws.send(JSON.stringify({type:'candidate',viewer:viewerID,candidate:{candidate:ev.candidate.candidate,sdpMid:ev.candidate.sdpMid,sdpMLineIndex:ev.candidate.sdpMLineIndex}})); } };

      ws=new WebSocket(wsUrl);
      ws.onopen=()=>{ log('WS open'); pill('pWs','ok','WS: open'); ws.send(JSON.stringify({type:'hello',role:'viewer'})); startHeartbeats(); };
      ws.onerror=()=>{ log('WS error'); pill('pWs','bad','WS: error'); restartSoon(); };
      ws.onclose=()=>{ log('WS closed'); pill('pWs','bad','WS: closed'); restartSoon(); };
      ws.onmessage=async(ev)=>{ const msg=JSON.parse(ev.data); if(msg.type==='pong') return;
        if(msg.type==='welcome'){ viewerID=msg.viewer_id; const offer=await pc.createOffer(); await pc.setLocalDescription(offer); ws.send(JSON.stringify({type:'offer',viewer:viewerID,sdp:{type:offer.type,sdp:offer.sdp}})); }
        else if(msg.type==='answer'){ await pc.setRemoteDescription(new RTCSessionDescription(msg.sdp)); log('Answer applied'); pill('pSig','ok','Signaling: answer'); hideOverlay(); ensurePlay(); }
        else if(msg.type==='candidate'){ try{ await pc.addIceCandidate(new RTCIceCandidate(msg.candidate)); }catch(e){ log('ICE add err '+e); } }
      };

      startStallDetector();
    }

    function showOverlay(text){ if(text) ovText.textContent=text; overlay.hidden=false; }
    function hideOverlay(){ overlay.hidden=true; }
    function startHeartbeats(){ if(hbTimer) clearInterval(hbTimer); hbTimer=setInterval(()=>{ try{ if(ws&&ws.readyState===1) ws.send(JSON.stringify({type:'ping',viewer:viewerID})); if(dc&&dc.readyState==='open') dc.send(JSON.stringify({type:'ping',viewer:viewerID})); }catch{} }, 2500); }
    function restartSoon(){ if(restarting) return; restarting=true; showOverlay('Reconnecting…'); setTimeout(()=>{ restarting=false; stopSession(); startViewer(); retryDelay=Math.min(retryDelay*1.5, 5000); }, retryDelay); }
    function stopSession(){ try{ if(hbTimer) clearInterval(hbTimer); hbTimer=null; }catch{} try{ if(stallTimer) clearInterval(stallTimer); stallTimer=null; }catch{} try{ dc?.close(); }catch{} try{ ws?.close(); }catch{} try{ pc?.close(); }catch{} }

    function startStallDetector(){
      if(stallTimer) clearInterval(stallTimer);
      let vBytesPrev=0, lastOk=performance.now();
      stallTimer=setInterval(async()=>{
        if(!pc) return;
        try{
          const stats = await pc.getStats(); let vBytes=0;
          stats.forEach(r=>{ if(r.type==='inbound-rtp' && r.kind==='video' && !r.isRemote) vBytes += (r.bytesReceived||0); });
          const now=performance.now();
          if(vBytes>vBytesPrev){ vBytesPrev=vBytes; lastOk=now; pill('pAv','ok','A/V: receiving'); hideOverlay(); ensurePlay(); }
          else if(now-lastOk>4500){ showOverlay('Reconnecting…'); restartSoon(); }
          else if(now-lastOk>2000){ pill('pAv','warn','A/V: stalled'); showOverlay('Buffering…'); }
        }catch{}
      }, 1000);
    }

    // Inputs (send only)
    let inputTimer=null,lastPayload='';
    const buttonMap={0:'A',1:'B',2:'X',3:'Y',4:'LB',5:'RB',8:'Back',9:'Start',10:'LS',11:'RS',12:'DPadUp',13:'DPadDown',14:'DPadLeft',15:'DPadRight'};
    function sendInput(o){ const s=JSON.stringify(o); if(s===lastPayload) return; lastPayload=s;
      try{ if(dc&&dc.readyState==='open') dc.send(s); else if(ws&&ws.readyState===1) ws.send(s); }catch{} }
    function startInputs(){
      if(inputTimer) return;
      inputTimer=setInterval(()=>{
        const gps=(navigator.getGamepads&&Array.from(navigator.getGamepads()).filter(Boolean))||[];
        const gp=gps.find(g=>g&&g.connected)||null;
        const buttons=[],axes=[0,0,0,0],triggers={LT:0,RT:0};
        if(gp){
          gp.buttons.forEach((b,i)=>{ if(b&&b.pressed){ const n=buttonMap[i]; if(n) buttons.push(n); }});
          axes[0]=gp.axes[0]||0; axes[1]=gp.axes[1]||0; axes[2]=gp.axes[2]||0; axes[3]=gp.axes[3]||0;
          if(gp.buttons[6]) triggers.LT=gp.buttons[6].value||0; if(gp.buttons[7]) triggers.RT=gp.buttons[7].value||0;
        }
        sendInput({type:'input',buttons,axes,triggers});
      },33);
      log('Input sender started');
    }

    // Start
    setChatSrc();
    startViewer();
    buildBanner();
    window.addEventListener('load', ()=>{ setTimeout(startInputs,300); document.body.classList.remove('chat-open'); chatWrap.hidden=true; });

    // Instant download logs
    document.getElementById('btnDownloadLogs').onclick=()=>{
      try{
        const blob = new Blob([logEl.textContent||''], {type:'text/plain'});
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = 'viewer-log.txt';
        document.body.appendChild(a);
        a.click();
        URL.revokeObjectURL(a.href);
        a.remove();
      }catch(e){ log('Download failed'); }
    };

    window.addEventListener('beforeunload', ()=>{ try{ clearInterval(inputTimer); }catch{} });
  </script>
</body>
</html>
