<!DOCTYPE html>
<html>
<head>
  <title>Viewer Controller + Stream</title>
  <style>
    body, html {
      margin: 0; padding: 0; height: 100%; width: 100%;
      background: black; overflow: hidden;
    }
    #debug-toggle { position: absolute; top: 10px; right: 10px; z-index: 1000; }
    #debug-panel {
      position: absolute; top: 40px; right: 10px;
      background: rgba(0,0,0,0.7); color: #0f0;
      font-family: monospace; font-size: 12px;
      padding: 5px; max-width: 340px; max-height: 240px;
      overflow-y: auto; display: none; z-index: 999;
    }
    #connection-indicator {
      position: absolute; top: 10px; right: 60px;
      width: 16px; height: 16px; border-radius: 50%;
      background-color: gray; border: 2px solid #222; z-index: 1000;
    }
    #remap-panel {
      position: absolute; bottom: 10px; left: 10px;
      background: rgba(0,0,0,0.7); color: #0f0;
      font-family: monospace; font-size: 12px;
      padding: 8px; max-height: 200px; overflow-y: auto;
      z-index: 1000;
    }
    #remap-toggle, #chat-toggle, #unmute {
      position: absolute; border: none; border-radius: 6px;
      color: #fff; font-weight: bold; cursor: pointer;
      box-shadow: 0 0 6px rgba(0,0,0,0.6); z-index: 1001;
    }
    #remap-toggle {
      bottom: 10px; right: 10px;
      background: linear-gradient(145deg, #10b981, #059669);
      padding: 6px 12px;
    }
    #chat-toggle {
      bottom: 50px; right: 10px;
      background: linear-gradient(145deg, #1f6feb, #3b82f6);
      padding: 8px 16px;
    }
    #unmute {
      top: 10px; left: 10px;
      background: rgba(0,0,0,0.7);
      padding: 6px 12px;
    }
    #chat-panel {
      position: absolute; top: 0; right: 0;
      width: 300px; height: 100%;
      background: #0b0f14; border-left: 2px solid #222;
      display: none; z-index: 1000;
    }
    #chat-iframe { width: 100%; height: 100%; border: none; }
    #webrtc {
      position: absolute; top: 0; left: 0;
      width: 100%; height: 100%;
      background: black; z-index: 0;
    }
    #state-line { margin-top: 6px; white-space: pre-wrap; }
  </style>
</head>
<body>

  <video id="webrtc" autoplay playsinline muted></video>
  <button id="unmute">Unmute</button>

  <div id="connection-indicator" title="Connection status"></div>
  <button id="debug-toggle">Toggle Debug</button>
  <div id="debug-panel">
    <div id="state-line"></div>
  </div>

  <div id="remap-panel"></div>
  <button id="remap-toggle">Remap</button>
  <button id="chat-toggle">Chat</button>
  <div id="chat-panel">
    <iframe id="chat-iframe" scrolling="no"></iframe>
  </div>

  <script>
    // Debug helpers
    const debugPanel = document.getElementById('debug-panel');
    const stateLine = document.getElementById('state-line');
    document.getElementById('debug-toggle')
      .addEventListener('click', () => {
        debugPanel.style.display =
          debugPanel.style.display === 'none' ? 'block' : 'none';
      });
    function logDebug(msg) {
      const div = document.createElement('div');
      div.textContent = msg;
      debugPanel.appendChild(div);
      debugPanel.scrollTop = debugPanel.scrollHeight;
    }
    function setIndicator(color) {
      document.getElementById('connection-indicator')
              .style.backgroundColor = color;
    }
    function renderState(pc, dc) {
      stateLine.textContent = [
        `ICE: ${pc.iceConnectionState}`,
        `DTLS: ${pc.connectionState}`,
        `Signaling: ${pc.signalingState}`,
        `DC: ${dc?.readyState ?? 'n/a'}`
      ].join(' | ');
    }

    // Determine relay host
    const params = new URLSearchParams(window.location.search);
    let host = params.get('relay') || window.location.host;
    host = host.replace(/^https?:\/\//, '').replace(/\/+$/, '');

    // Populate Twitch chat iframe
    document.getElementById('chat-iframe').src =
      `https://www.twitch.tv/embed/junkfoodjon/chat?parent=${host}`;

    function startViewer(wsUrl) {
      logDebug('WS URL → ' + wsUrl);
      const ws = new WebSocket(wsUrl);
      let viewerID = null;

      // Gamepad remap setup
      const buttonMap = {
        0:'A',1:'B',2:'X',3:'Y',
        4:'LB',5:'RB',8:'Back',9:'Start',
        10:'LS',11:'RS',12:'DPadUp',
        13:'DPadDown',14:'DPadLeft',15:'DPadRight'
      };
      let remap = JSON.parse(localStorage.getItem('remapConfig')||'{}');
      Object.values(buttonMap).forEach(b=>{ if(!remap[b]) remap[b]=b; });
      function buildRemapUI(){
        const panel = document.getElementById('remap-panel');
        panel.innerHTML = '<b>Button Remap</b><br/>';
        Object.values(buttonMap).forEach(btn=>{
          const row = document.createElement('div');
          row.textContent = btn+' → ';
          const sel = document.createElement('select');
          Object.values(buttonMap).forEach(t=>{
            const opt = document.createElement('option');
            opt.value=opt.textContent=t;
            if(remap[btn]===t) opt.selected=true;
            sel.appendChild(opt);
          });
          sel.onchange=()=>{
            remap[btn]=sel.value;
            localStorage.setItem('remapConfig',JSON.stringify(remap));
            logDebug(`Remap ${btn}→${sel.value}`);
          };
          row.appendChild(sel);
          panel.appendChild(row);
        });
      }
      buildRemapUI();
      let remapVisible=true;
      document.getElementById('remap-toggle')
        .addEventListener('click',()=>{
          document.getElementById('remap-panel').style.display =
            remapVisible?'none':'block';
          remapVisible = !remapVisible;
        });
      // WebRTC & DataChannel
      const pc = new RTCPeerConnection({
        iceServers:[{urls:'stun:stun.l.google.com:19302'}],
        sdpSemantics:'unified-plan'
      });
      const videoEl = document.getElementById('webrtc');
      const dc = pc.createDataChannel('inputs',{ordered:true});
      pc.addTransceiver('video',{direction:'recvonly'});
      pc.addTransceiver('audio',{direction:'recvonly'});

      pc.ontrack = e=>{
        videoEl.srcObject = e.streams[0];
        logDebug('Track attached');
        videoEl.play().catch(err=>logDebug('Autoplay blocked: '+err));
      };
      dc.onopen  = ()=>{ logDebug('DC open'); renderState(pc,dc); };
      dc.onclose = ()=>{ logDebug('DC closed'); renderState(pc,dc); };

      pc.oniceconnectionstatechange = ()=>{
        renderState(pc,dc);
        const s=pc.iceConnectionState;
        setIndicator(s==='connected'||s==='completed'?'limegreen'
          :s==='checking'?'gold':'gray');
        logDebug('ICE '+s);
      };

      pc.onconnectionstatechange = ()=>{
        logDebug('Conn state '+pc.connectionState);
        renderState(pc,dc);
      };

      pc.onicecandidate = ev=>{
        if(ev.candidate && viewerID){
          ws.send(JSON.stringify({
            type:'candidate', viewer:viewerID,
            candidate:{
              candidate:ev.candidate.candidate,
              sdpMid:ev.candidate.sdpMid,
              sdpMLineIndex:ev.candidate.sdpMLineIndex
            }
          }));
          logDebug('Sent ICE candidate');
        }
      };

      ws.onopen = ()=>{
        logDebug('WS open');
        setIndicator('gold');
        ws.send(JSON.stringify({type:'hello',role:'viewer'}));
      };

      ws.onmessage = async evt=>{
        const msg = JSON.parse(evt.data);
        if(msg.type==='welcome'){
          viewerID=msg.viewer_id;
          logDebug('Welcome '+viewerID);
          const offer = await pc.createOffer();
          await pc.setLocalDescription(offer);
          ws.send(JSON.stringify({
            type:'offer', role:'viewer',
            viewer:viewerID, sdp:pc.localDescription
          }));
          renderState(pc,dc);

        } else if(msg.type==='answer'){
          await pc.setRemoteDescription(
            new RTCSessionDescription(msg.sdp)
          );
          logDebug('Answer applied');
          renderState(pc,dc);

        } else if(msg.type==='candidate'){
          await pc.addIceCandidate(
            new RTCIceCandidate(msg.candidate)
          );
          logDebug('Candidate added');
        }
      };

      ws.onerror = err=>{
        logDebug('WebSocket error: '+ (err.message||JSON.stringify(err)));
        setIndicator('gray');
      };
      ws.onclose = ()=>{
        logDebug('WS closed');
        setIndicator('gray');
      };

      // Gamepad polling
      const DEAD=0.08, POLL_MS=33;
      function applyDZ(v){ return Math.abs(v)<DEAD?0:v; }
      function poll(){
        const gps=navigator.getGamepads?.()||[];
        if(gps[0]&&viewerID){
          const gp=gps[0], btns=[], axes=gp.axes.map(v=>+applyDZ(v).toFixed(2));
          gp.buttons.forEach((b,i)=>{
            if(b.pressed && buttonMap[i] && i!==6&&i!==7){
              btns.push(remap[buttonMap[i]]);
            }
          });
          const trg={LT:gp.buttons[6]?.value||0, RT:gp.buttons[7]?.value||0};
          const payload={viewer:viewerID,buttons:btns,axes,triggers:trg};
          if(dc.readyState==='open') dc.send(JSON.stringify(payload));
          else if(ws.readyState===1) ws.send(JSON.stringify(payload));
        }
        requestAnimationFrame(poll);
      }
      window.addEventListener('gamepadconnected',()=>{ logDebug('GP connected'); poll();});

      // Chat toggle & Unmute
      document.getElementById('chat-toggle')
        .addEventListener('click',()=>{
          const p = document.getElementById('chat-panel');
          p.style.display = p.style.display==='block'?'none':'block';
          logDebug(p.style.display+' chat');
        });
      document.getElementById('unmute')
        .addEventListener('click',()=>{
          videoEl.muted=false;
          videoEl.play().catch(e=>logDebug('Unmute err:'+e));
        });
    }

    // Kick off
    (()=>{
      const wsUrl = `wss://${host}/ws/viewer`;
      startViewer(wsUrl);
    })();
  </script>
</body>
</html>
